<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>مساعد الأبحاث الذكي - إنشاء أبحاث بالذكاء الاصطناعي</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Rajdhani:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
        --background-color: #0a0f1a;
        --primary-color: #101828;
        --secondary-color: #1d2939;
        --accent-color: #00aaff;
        --accent-color-darker: #0088cc;
        --glow-color: rgba(0, 170, 255, 0.5);
        --text-color: #e0e0e0;
        --subtext-color: #98a2b3;
        --border-color: #344054;
    }

    body { font-family: 'Cairo', sans-serif; background-color: var(--background-color); color: var(--text-color); }
    
    #ai-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
    }

    .control-panel {
        background-color: rgba(16, 24, 40, 0.8);
        backdrop-filter: blur(5px);
        border: 1px solid var(--border-color);
        max-height: 90vh;
    }

    .panel-title {
        color: var(--accent-color);
        text-shadow: 0 0 8px var(--glow-color);
    }

    .lang-btn { background-color: var(--secondary-color); border: 1px solid var(--border-color); }
    .lang-btn.active { background-color: var(--accent-color); color: var(--primary-color); border-color: var(--accent-color); box-shadow: 0 0 15px var(--glow-color); transform: scale(1.05); }

    #topicInput { background-color: var(--secondary-color); border: 1px solid var(--border-color); }
    #topicInput:focus { border-color: var(--accent-color); box-shadow: 0 0 10px var(--glow-color); outline: none; }

    #generateBtn, #downloadPdfBtn { background-color: var(--accent-color); color: var(--primary-color); border-color: var(--accent-color); transition: all 0.3s ease; }
    #generateBtn:hover, #downloadPdfBtn:hover:not(:disabled) { background-color: var(--accent-color-darker); box-shadow: 0 0 15px var(--glow-color); }
    #generateBtn:disabled { background-color: var(--secondary-color); color: var(--subtext-color); cursor: not-allowed; }

    .research-output-container { 
        background-color: rgba(255, 255, 255, 0.95); 
        color: #000; 
        border: 1px solid var(--border-color); 
        font-family: 'Cairo', sans-serif; 
        height: 90vh;
    }
    
    /* Language-specific styles */
    .research-output-container.content-lang-ar { 
        direction: rtl; 
        text-align: right; 
        font-family: 'Cairo', sans-serif; 
    }
    .research-output-container.content-lang-en { 
        direction: ltr; 
        text-align: left; 
        font-family: 'Lato', sans-serif; 
    }
    .research-output-container.content-lang-fr { 
        direction: ltr; 
        text-align: left; 
        font-family: 'Lato', sans-serif; 
    }
    
    /* Interface direction based on selected language */
    [lang="ar"] .control-panel { direction: rtl; text-align: right; }
    [lang="en"] .control-panel { direction: ltr; text-align: left; }
    [lang="fr"] .control-panel { direction: ltr; text-align: left; }

    .research-output-content { 
        line-height: 1.6; 
        page-break-inside: avoid;
        max-width: 210mm; /* A4 width */
        margin: 0 auto;
        padding: 20mm; /* A4 margins */
    }
    .research-output-content h1, .research-output-content h2, .research-output-content h3 { 
        color: #000; 
        margin-top: 1.2rem; 
        margin-bottom: 0.6rem; 
        border-bottom: 1px solid #e0e0e0; 
        padding-bottom: 0.25rem;
        page-break-after: avoid;
        orphans: 3;
        widows: 3;
    }
    .research-output-content h1 { font-size: 1.6rem; page-break-before: auto; }
    .research-output-content h2 { font-size: 1.4rem; page-break-before: avoid; }
    .research-output-content h3 { font-size: 1.2rem; }
    .research-output-content p { 
        margin-bottom: 0.8rem; 
        color: #000; 
        text-align: justify;
        orphans: 2;
        widows: 2;
        page-break-inside: avoid;
    }
    .research-output-content ul { 
        list-style-type: disc; 
        margin-right: 1.2rem; 
        margin-left: 1.2rem; 
        color: #000;
        page-break-inside: avoid;
    }
    
    /* Page break utilities for PDF */
    .page-break { page-break-before: always; }
    .avoid-break { page-break-inside: avoid; }
    .section-break { 
        page-break-before: auto; 
        margin-top: 2rem; 
        margin-bottom: 1rem;
    }

    .loader { border: 8px solid var(--secondary-color); border-top: 8px solid var(--accent-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .image-placeholder { 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        border: 2px dashed var(--accent-color); 
        border-radius: 0.5rem; 
        padding: 0.8rem 0.6rem; 
        margin: 1rem 0; 
        text-align: center; 
        color: var(--accent-color); 
        font-weight: 600; 
        cursor: help;
        page-break-inside: avoid;
        page-break-before: avoid;
        page-break-after: avoid;
        max-width: 380px;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
    }
    .inserted-image { 
        width: 100%; 
        max-width: 350px; 
        height: auto; 
        border-radius: 0.5rem; 
        margin: 1rem auto; 
        display: block; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        page-break-inside: avoid;
        page-break-before: avoid;
        page-break-after: avoid;
    }
    
    /* Enhanced image container for PDF */
    .image-container-pdf {
        page-break-inside: avoid;
        margin: 1rem 0;
        text-align: center;
        max-width: 380px;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
        border: 2px solid var(--accent-color);
        border-radius: 0.5rem;
        padding: 0.5rem;
        background-color: rgba(59, 130, 246, 0.05);
    }

    .image-panel { border-top: 1px solid var(--border-color); margin-top: 1.5rem; padding-top: 1.5rem; }
    #imageGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.75rem; }
    #imageGrid .image-container { position: relative; cursor: pointer; }
    #imageGrid img { width: 100%; height: 80px; object-fit: cover; border-radius: 0.5rem; transition: transform 0.3s ease; }
    #imageGrid .image-container:hover img { transform: scale(1.05); }
    #imageGrid .image-number { position: absolute; top: 0.25rem; right: 0.25rem; background-color: rgba(0,0,0,0.7); color: white; width: 1.25rem; height: 1.25rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; }
    
    #placementModal { z-index: 100; }
    .modal-content { background-color: var(--primary-color); border: 1px solid var(--border-color); }
    .slot-button { background-color: var(--secondary-color); border: 1px solid var(--border-color); }
    .slot-button:hover { background-color: var(--accent-color); color: var(--primary-color); }
    .slot-button:disabled { background-color: #2a3b52; color: var(--subtext-color); cursor: not-allowed; }
    
    .image-size-controls { margin-top: 0.5rem; }
    .size-btn { 
        background-color: var(--secondary-color); 
        color: var(--text-color); 
        border: 1px solid var(--border-color); 
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .size-btn:hover { 
        background-color: var(--accent-color); 
        color: var(--primary-color); 
        border-color: var(--accent-color);
    }
    .size-btn.active { 
        background-color: var(--accent-color); 
        color: var(--primary-color); 
        border-color: var(--accent-color);
        box-shadow: 0 0 8px var(--glow-color);
    }

    /* Hide size control buttons when generating PDF */
    .pdf-generation .image-size-controls {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
    }
    
    /* Additional rules to ensure buttons are hidden in PDF */
    .pdf-generation .size-btn {
        display: none !important;
        visibility: hidden !important;
    }
    
    /* Ensure no margins/padding from hidden controls */
    .pdf-generation .image-container-pdf .image-size-controls {
        margin: 0 !important;
        padding: 0 !important;
        line-height: 0 !important;
    }
    
    /* PDF layout optimization - reduce side margins */
    .pdf-generation {
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        max-width: 100% !important;
    }
    
    /* Optimize content width for PDF */
    .pdf-generation .research-output-content {
        padding-left: 0.8rem !important;
        padding-right: 0.8rem !important;
        padding-top: 0.5rem !important;
        margin: 0 !important;
        max-width: none !important;
    }
    
    /* Center and reduce top spacing for main title in PDF */
    .pdf-generation h1:first-child {
        text-align: center !important;
        margin-top: 0 !important;
        padding-top: 0 !important;
        margin-bottom: 1.5rem !important;
        font-size: 1.8rem !important;
        font-weight: bold !important;
    }
    
    /* Remove top margin from research output container for PDF */
    .pdf-generation #researchOutputContainer {
        padding-top: 0 !important;
        margin-top: 0 !important;
    }
    
    /* Text direction for PDF based on content language */
    .pdf-generation.content-lang-en .research-output-content,
    .pdf-generation.content-lang-fr .research-output-content {
        direction: ltr !important;
        text-align: left !important;
    }
    
    .pdf-generation.content-lang-en .research-output-content *,
    .pdf-generation.content-lang-fr .research-output-content * {
        direction: ltr !important;
        text-align: left !important;
    }
    
    .pdf-generation.content-lang-ar .research-output-content,
    .pdf-generation.content-lang-ar .research-output-content * {
        direction: rtl !important;
        text-align: right !important;
    }

  </style>
</head>
<body>
  <canvas id="ai-background"></canvas>
  <div class="page-container w-full h-screen p-4 lg:p-8 grid lg:grid-cols-[400px_1fr] gap-8 relative z-10">
    
    <!-- Left Sidebar (Controls + Image Panel) -->
    <div class="control-panel w-full p-6 sm:p-8 rounded-2xl shadow-2xl flex flex-col overflow-y-auto">
      <div>
        <h2 class="panel-title text-2xl font-bold text-center mb-6"><i class="fas fa-robot"></i> <span id="appTitle">مساعد الأبحاث الذكي</span></h2>
        <div class="lang-switch flex justify-center gap-2 mb-6">
          <button class="lang-btn rounded-full py-1 px-4 text-sm font-bold transition-all active" id="arBtn" type="button">العربية</button>
          <button class="lang-btn rounded-full py-1 px-4 text-sm font-bold transition-all" id="frBtn" type="button">Français</button>
          <button class="lang-btn rounded-full py-1 px-4 text-sm font-bold transition-all" id="enBtn" type="button">English</button>
        </div>
        <div class="space-y-4">
            <div>
                <label for="topicInput" id="topicLabel" class="block mb-2 text-lg font-semibold">أدخل موضوع البحث</label>
                <div class="relative">
                    <input type="text" id="topicInput" placeholder="مثال: المجموعة الشمسية" class="w-full rounded-lg text-base p-3 pr-12 text-white placeholder-gray-400 focus:ring-2 focus:outline-none" />
                    <button id="translateBtn" title="ترجمة الموضوع" class="absolute left-2 top-1/2 transform -translate-y-1/2 p-2 rounded-md text-white hover:bg-blue-600 transition-all duration-200">
                        <i id="translateBtnIcon" class="fas fa-language text-lg"></i>
                    </button>
                </div>
            </div>
            <button id="generateBtn" class="w-full py-3 px-6 rounded-lg text-lg font-bold cursor-pointer transition-all flex items-center justify-center gap-2">
              <span id="generateBtnText">إنشاء البحث</span>
              <i id="generateBtnIcon" class="fas fa-cogs"></i>
            </button>
            <button id="downloadPdfBtn" disabled class="w-full py-3 px-6 rounded-lg text-lg font-bold cursor-pointer transition-all disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-file-pdf"></i> <span id="downloadBtnText">تحميل كملف PDF</span>
            </button>
        </div>
        
        <!-- Image Panel (Moved directly below PDF button) -->
        <div class="image-panel mt-6">
            <h3 class="panel-title text-xl font-bold text-center mb-4" id="imageSidebarTitle">معرض الصور</h3>
            <div id="imagePanelLoader" class="hidden items-center justify-center h-24">
                <div class="loader" style="width: 40px; height: 40px; border-width: 4px;"></div>
            </div>
            <div id="imageGrid">
                <!-- Images will be dynamically inserted here -->
            </div>
        </div>
      </div>
    </div>

    <!-- Research Output -->
    <div id="researchOutputContainer" class="research-output-container rounded-lg shadow-lg p-8 overflow-y-auto w-full">
        <div id="outputPlaceholder" class="flex items-center justify-center h-full text-center text-gray-400">
            <div>
                <i class="fas fa-book-open fa-4x mb-4"></i>
                <h3 id="placeholderTitle" class="text-2xl font-bold text-gray-500">سيظهر بحثك هنا</h3>
                <p id="placeholderText" class="mt-2">أدخل موضوعاً واضغط على زر الإنشاء لتبدأ.</p>
            </div>
        </div>
        <div id="loader" class="hidden items-center justify-center h-full">
            <div class="loader"></div>
        </div>
        <div id="researchOutputContent" class="research-output-content">
            <!-- Default content to show interface working -->
            <h1>أشرف حكيمي: من شوارع مدريد إلى قمة المجد الكروي</h1>
            <p>أشرف حكيمي هو أحد أشهر لاعبي كرة القدم في العالم اليوم وهو فخر للمغرب وللعرب. ولد حكيمي في إسبانيا من أبوين مغربيين واختار تمثيل المغرب في كرة القدم. في هذا البحث البسيط سنتعرف على مسيرة هذا النجم اللامع من بداياته حتى وصوله إلى العالمية.</p>
            <div class="image-placeholder" id="image-slot-1" data-slot-number="1" title="مكان مخصص للصورة رقم 1"><i class="fas fa-image mr-2 ml-2"></i><span class="placeholder-text">ضع الصورة رقم 1 هنا</span></div>
            <h2>البدايات مع ريال مدريد</h2>
            <p>بدأ أشرف حكيمي مسيرته الكروية في سن مبكرة، حيث انضم إلى أكاديمية نادي ريال مدريد الإسباني العريق وهو طفل. تدرج في جميع الفئات السنية للنادي، مظهرًا موهبة استثنائية في مركز الظهير الأيمن، حيث تميز بسرعته الفائقة وقدرته على الهجوم والدفاع بكفاءة عالية. في عام 2017، تحقق حلمه باللعب مع الفريق الأول لريال مدريد، ليصبح أول لاعب مغربي يمثل النادي الملكي.</p>
            <h2>التألق في أوروبا: دورتموند، إنتر ميلان، وباريس سان جيرمان</h2>
            <p>بحثًا عن فرصة للعب بشكل أساسي، انتقل حكيمي إلى نادي بوروسيا دورتموند الألماني على سبيل الإعارة، وهناك انفجرت موهبته بشكل كبير، حيث أصبح من أفضل الأظهرة في العالم. بعد ذلك، انتقل إلى نادي إنتر ميلان الإيطالي وساهم في فوزه بلقب الدوري الإيطالي. حاليًا، يلعب حكيمي مع نادي باريس سان جيرمان الفرنسي، أحد أكبر الأندية في أوروبا، ويواصل تقديم مستويات رائعة.</p>
            <div class="image-placeholder" id="image-slot-2" data-slot-number="2" title="مكان مخصص للصورة رقم 2"><i class="fas fa-image mr-2 ml-2"></i><span class="placeholder-text">ضع الصورة رقم 2 هنا</span></div>
            <h2>أسد الأطلس: مسيرته مع المنتخب المغربي</h2>
            <p>على الرغم من ولادته في إسبانيا، اختار أشرف حكيمي بقلبه أن يمثل وطنه الأم، المغرب. أصبح ركيزة أساسية في تشكيلة "أسود الأطلس"، وشارك معهم في العديد من البطولات الهامة. كانت أبرز محطاته مع المنتخب هي المشاركة التاريخية في كأس العالم 2022 في قطر، حيث كان له دور كبير في وصول المغرب إلى نصف النهائي كأول منتخب عربي وإفريقي يحقق هذا الإنجاز، وأصبحت ركلته الترجيحية الحاسمة ضد إسبانيا أيقونة خالدة في ذاكرة المغاربة.</p>
            <h2>خاتمة</h2>
            <p>أشرف حكيمي ليس مجرد لاعب كرة قدم موهوب، بل هو قصة نجاح ملهمة للشباب العربي والمغربي. بفضل عزيمته واجتهاده، استطاع أن يصل إلى أعلى المستويات في عالم كرة القدم، وأصبح سفيرًا مشرفًا لبلده، يرفع راية المغرب عاليًا في المحافل الدولية.</p>
        </div>
    </div>
  </div>

  <!-- Placement Modal -->
  <div id="placementModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4">
      <div class="modal-content w-full max-w-md p-6 rounded-2xl shadow-lg">
          <h4 id="modalTitle" class="text-lg font-bold text-center mb-4">اختر مكان وضع الصورة</h4>
          
          <!-- Image Preview Section -->
          <div id="imagePreviewSection" class="mb-4 text-center">
              <div class="image-preview-container bg-gray-100 dark:bg-gray-700 rounded-lg p-3 mb-2">
                  <img id="previewImage" src="" alt="معاينة الصورة" class="max-w-full max-h-32 object-contain mx-auto rounded" />
              </div>
              <p id="previewTitle" class="text-sm text-gray-600 dark:text-gray-300 truncate"></p>
          </div>
          
          <div id="modalSlots" class="flex flex-wrap justify-center gap-3">
              <!-- Dynamic slot buttons will be inserted here -->
          </div>
          <button id="cancelPlacement" class="w-full mt-4 py-2 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
              <span id="cancelText">إلغاء</span>
          </button>
      </div>
  </div>

  <script src="{{ url_for('static', filename='js/background.js') }}"></script>
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
